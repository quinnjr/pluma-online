version: "3.8"

services:
  # nginx:
  #   container_name: pluma-online-nginx
  #   build:
  #     context: ./nginx
  #     cache_from:
  #       - alpine:latest
  #       - fiubiorg/nginx:latest
  #     labels:
  #       com.pluma-nginx.description: "Custom NGINX container for PluMA Online"
  #       com.pluma-nginx.maintainer: "Joseph R. Quinn <quinn.josephr@protonmail.com>"
  #     args:
  #       - NGINX_VERSION=1.19.10
  #   image: fiubiorg/nginx:latest
  #   volumes:
  #     - web:/src/http
  #     - ./nginx/etc/nginx:/etc/nginx
  #     - ./nginx/server-configs-nginx/h5bp:/etc/nginx/h5bp
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   restart: unless-stopped
  #   depends_on:
  #     - webapp

  database:
    container_name: pluma-online-database
    image: mongo:latest
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    ports:
      - 5432:5432
    volumes:
      - database:/data/db

  redis:
    container_name: pluma-redis
    image: redis:alpine

  webapp:
    container_name: pluma-online-webapp
    build:
      context: ./
      dockerfile: Dockerfile
      cache_from:
        - node:lts-alpine
      labels:
        com.pluma-backend.description: "Container for PluMA Online"
        com.pluma-backend.maintainer: "Joseph R. Quinn <423821+quinnjr@users.noreply.github.com>"
    depends_on:
      - database
      - redis
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    environment:
      APP_JWT_SECRET: ${APP_JWT_SECRET}
      DATABASE_URL: ${DATABASE_URL}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

volumes:
  web:
  database:
